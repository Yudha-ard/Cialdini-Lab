services:
  mongodb:
    image: mongo:7.0
    container_name: tegalsec-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_DATABASE: tegalsec_lab
    volumes:
      - mongodb_data:/data/db
    networks:
      - tegalsec-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: tegalsec-backend
    restart: unless-stopped
    ports:
      - "8001:8001"
    environment:
      - MONGO_URL=mongodb://tegalsec-mongodb:27017
      - DB_NAME=tegalsec_lab
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-default_insecure_secret_for_dev}
      - ALGORITHM=HS256
      - PYTHONUNBUFFERED=1
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - tegalsec-network
    command: >
      sh -c "
      echo 'Waiting for MongoDB...' &&
      sleep 5 &&
      echo 'Seeding database...' &&
      python seed_data.py || echo 'seed_data failed or skipped' &&
      python seed_indonesia_challenges.py || echo 'seed_indonesia failed or skipped' &&
      python seed_massive_challenges.py || echo 'seed_massive failed or skipped' &&
      python seed_final_10.py || echo 'seed_final failed or skipped' &&
      python seed_courses.py || echo 'seed_courses failed or skipped' &&
      echo 'Database seeded successfully!' &&
      echo 'Starting backend server...' &&
      uvicorn server:app --host 0.0.0.0 --port 8001 --reload
      "

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: tegalsec-frontend
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - REACT_APP_BACKEND_URL=http://localhost:8001
      - WDS_SOCKET_PORT=0
      - CHOKIDAR_USEPOLLING=true
      - WATCHPACK_POLLING=true
    depends_on:
      backend:
        condition: service_started
    networks:
      - tegalsec-network
    stdin_open: true
    tty: true

volumes:
  mongodb_data:
    driver: local

networks:
  tegalsec-network:
      driver: bridge